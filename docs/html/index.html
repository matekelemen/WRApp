<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WRApplication: WRApplication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">WRApplication
   </div>
   <div id="projectbrief">External kratos &quot;application&quot; for multiscale time integration.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">WRApplication </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2WRApp_2WRApp_2readme"></a> <a class="anchor" id="table-of-contents"></a></p>
<h1><a class="anchor" id="autotoc_md0"></a>
Table of Contents</h1>
<ul>
<li><a class="el" href="index.html#setup">Setup</a></li>
<li><a class="el" href="index.html#checkpointing">Checkpointing</a><ul>
<li>Purpose</li>
<li>Definitions<ul>
<li>Analysis Path</li>
<li>Snapshot</li>
<li>Checkpoint</li>
</ul>
</li>
<li>Behaviour<ul>
<li>Loading Checkpoints</li>
<li>Writing Checkpoints</li>
<li>Example</li>
</ul>
</li>
<li>Issues<ul>
<li>Internal State</li>
<li>Output</li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="index.html#registry">Registry</a><ul>
<li>C++</li>
<li>Python</li>
</ul>
</li>
<li><a class="el" href="index.html#testing">Testing</a><ul>
<li>C++</li>
<li>Python</li>
</ul>
</li>
</ul>
<p><a class="anchor" id="setup"></a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Setup</h1>
<p>Being an *"application"* of <a href="https://github.com/KratosMultiphysics/Kratos">KratosMultiphysics</a>, this project is meant to be compiled along kratos as an external app. Clone this repo and invoke <code>add_app</code> with its path in the kratos configure script. Note this application requires a few extra PRs that have been in limbo in the KratosMultiphysics repository. Use the <a href="https://github.com/kratosmultiphysics/kratos/tree/wrapp">'wrapp' branch</a> instead. </p><div class="fragment"><div class="line"># configure.sh</div>
<div class="line">...</div>
<div class="line">add_app(&quot;path_to_the_cloned_repo&quot;)</div>
<div class="line">...</div>
</div><!-- fragment --><p>See the full documentation <a href="https://matekelemen.github.io/WRApp/docs/html/index.html">here</a>.</p>
<p><a class="anchor" id="checkpointing"></a></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Checkpointing</h1>
<p><a class="anchor" id="checkpointing.purpose"></a></p>
<h2><a class="anchor" id="autotoc_md3"></a>
Purpose</h2>
<p>Checkpointing is meant to help with loading earlier states of the analysis in order to retry/resume the computation with additional information "from the future".</p>
<p><a class="anchor" id="checkpointing.definitions"></a></p>
<h2><a class="anchor" id="autotoc_md4"></a>
Definitions</h2>
<p><a class="anchor" id="checkpointing.definitions.analysis-path"></a></p>
<h3><a class="anchor" id="autotoc_md5"></a>
Analysis Path</h3>
<p>An analysis path is an ordered set of continuous solution steps from which no checkpoints were loaded. Analysis paths begin at the start of the analysis' and end at dead-ends or at the analysis end. A new path is created after each time a <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> is loaded, inheriting the solution steps preceding the loaded <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code>, while the previous path's last step becomes a <b>dead-end</b>. Paths may share sections but always have a unique end step, and can only diverge at steps where a valid <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> is available. The <b>solution path</b> is an analysis path ending at the analysis' end.</p><ul>
<li>An analysis has exactly one solution path but may have zero or more paths with dead-ends.</li>
<li>The solution path is the only path that does not end in a dead-end.</li>
</ul>
<p><a class="anchor" id="checkpointing.definitions.snapshot"></a></p>
<h3><a class="anchor" id="autotoc_md6"></a>
Snapshot</h3>
<p>A <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code> stores all data of a model part's nodes, elements, conditions and <code>ProcessInfo</code> at the state when it was created. The data can either be stored on disk in an HDF5 file (<code><a class="el" href="classHDF5Snapshot.html" title="Class representing a snapshot of a ModelPart state and its associated output file in HDF5 format.">HDF5Snapshot</a></code>) or in memory (<code><a class="el" href="classSnapshotInMemory.html" title="Snapshot that stores/fetches its data in/from memory.">SnapshotInMemory</a></code> - not implemented yet). A <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code> stores no data related to previous steps. This allows changing time integration schemes on the fly, provided that enough snapshots are available to fill the buffer.</p>
<p><a class="anchor" id="checkpointing.definitions.checkpoint"></a></p>
<h3><a class="anchor" id="autotoc_md7"></a>
Checkpoint</h3>
<p>A <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> consists of one or more consecutive <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s from the same solution path; the exact number depends on the buffer size of the <code>ModelPart</code>. When a <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> is loaded, its related <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s are read in order to fill the buffer of the target <code>ModelPart</code>. <b>A <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> is valid iff all required <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s exist</b>.</p>
<p><a class="anchor" id="checkpointing.behaviour"></a></p>
<h2><a class="anchor" id="autotoc_md8"></a>
Behaviour</h2>
<p><a class="anchor" id="checkpointing.behaviour.loading-checkpoints"></a></p>
<h3><a class="anchor" id="autotoc_md9"></a>
Loading Checkpoints</h3>
<ul>
<li>A <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> can only be loaded if all related <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s are available, the target <code>ModelPart</code> has all variables stored in the <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s, and its buffer size equals the number of <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s in the <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code>.</li>
<li><b>Obsolete <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code>s</b> and their related <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s on the dead-end of paths <b>are not deleted by default</b>.</li>
</ul>
<p><a class="anchor" id="checkpointing.behaviour.writing-checkpoints"></a></p>
<h3><a class="anchor" id="autotoc_md10"></a>
Writing Checkpoints</h3>
<ul>
<li>Creating a <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> at a specific step involves constructing <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s before that step in order to capture buffer data.</li>
<li><code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code>s at the first steps of the analysis may not have sufficient data for earlier <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s; these cases must be handled manually by providing <code><a class="el" href="classSnapshot.html" title="Class representing a snapshot of a ModelPart state.">Snapshot</a></code>s with data on initial conditions.</li>
</ul>
<p><a class="anchor" id="checkpointing.behaviour.example"></a></p>
<h3><a class="anchor" id="autotoc_md11"></a>
Example</h3>
<p>Example analysis steps with buffer size 3: </p><div class="fragment"><div class="line">                                                               step#   checkpoint  snapshot</div>
<div class="line">begin (path 0,1,2,3, step 0)                                     0</div>
<div class="line">  |                                                              1</div>
<div class="line">  V                                                              2                    x</div>
<div class="line">  |                                                              3                    x</div>
<div class="line">  A-----&gt;-----+-----------&gt;-----------+                          4          A         x</div>
<div class="line">  |           |                       |                          5</div>
<div class="line">path 0      path 1,2                path 3                       6                    x</div>
<div class="line">  |           |                       |                          7                    x</div>
<div class="line">  V           B-----&gt;-----+           V                          8          B         x</div>
<div class="line">  |           |           |           |                          9</div>
<div class="line">load A      path 1     path 2         |                          10</div>
<div class="line">              |           |           |                          11</div>
<div class="line">              V           V          end (path 3, step 12)       12</div>
<div class="line">            load B        |                                      13</div>
<div class="line">                          |                                      14</div>
<div class="line">                        load A                                   15</div>
</div><!-- fragment --><p>In the example above, the following <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code>-related operations are performed in order: 1) Begin analysis (path 0, step 0). 2) Write checkpoint A (path 0, step 2-4). 3) Dead-end =&gt; load checkpoint A (path 0, step 10 =&gt; path 1, step 4). 4) Write checkpoint B (path 1, step 6-8). 5) Dead-end =&gt; load checkpoint B (path 1, step 13 =&gt; path 2, step 8). 6) Dead-end =&gt; load checkpoint A (path 2, step 15 =&gt; path 3, step 4). 7) End analysis (path 3, step 12).</p>
<p>Even though the analysis terminates at step 12, the total number of computed steps is actually 34 (10 in path 0, 9 in path 1, 7 in path 2, and 8 in path 3) and the highest step index during the analysis was 15. Keep this in mind while reading the next section.</p>
<p>It is possible to load a <code><a class="el" href="classCheckpoint.html" title="Class representing a checkpoint, consisting of one or more consecutive Snapshot s.">Checkpoint</a></code> from the dead-end of an abandoned path (the abandoned path is not changed, but a new one is created that shares its section preceding the loaded checkpoint), though no example is given of that here.</p>
<p><a class="anchor" id="checkpointing.issues"></a></p>
<h2><a class="anchor" id="autotoc_md12"></a>
Issues</h2>
<p><a class="anchor" id="checkpointing.issues.internal-state"></a></p>
<h3><a class="anchor" id="autotoc_md13"></a>
Internal State</h3>
<p>A lot of <code>Process</code>es, solvers, and even the <code>AnalysisStage</code> keeps track of step indices and time internally, independently of their associated <code>ModelPart</code>s. This can lead to all kinds of bugs that need to be tracked down individually for each object. The best solution is to modify these objects such that they query their <code>Model</code> or <code>ModelPart</code>s when they need information about the current time and step, instead of relying on internally managed state.</p>
<p><a class="anchor" id="checkpointing.issues.output"></a></p>
<h3><a class="anchor" id="autotoc_md14"></a>
Output</h3>
<p>Output generators (ideally <code>OutputProcess</code>es) need to be configured such that they are allowed to overwrite existing output files. This is essential because an analysis involving checkpoints may pass through completely identical steps multiple times, triggering the same output generator.</p>
<p>Furthermore, the checkpoint system has no information about generated outputs, so if output is generated at steps/times that exceed the final step/time at which the analysis terminates, those output files will not be overwritten nor deleted, even though they are not part of the solution path. For this reason, a cleanup process should be executed at the end of the analysis.</p>
<p><a class="anchor" id="registry"></a></p>
<h1><a class="anchor" id="autotoc_md15"></a>
Registry</h1>
<p><a class="anchor" id="registry.cpp"></a></p>
<h2><a class="anchor" id="autotoc_md16"></a>
C++</h2>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd></dd></dl>
<p><a class="anchor" id="registry.python"></a></p>
<h2><a class="anchor" id="autotoc_md17"></a>
Python</h2>
<p>The python registry in <code>WRApplication</code> is automatically populated at module initialization time. To register new <b>python classes</b>, they must inherit from <code><a class="el" href="classWRAppClass.html" title="WRApp::WRAppClass with a replaced metaclass for compatibility with abc.">WRAppClass</a></code> (directly or indirectly), and their containing script/module must eventually be imported in the root initializer.</p>
<p>Inheriting from <code><a class="el" href="classWRAppClass.html" title="WRApp::WRAppClass with a replaced metaclass for compatibility with abc.">WRAppClass</a></code> also comes with some obligations in order to help with automation later:</p><ul>
<li>Derived classes must invoke the base constructor <code>super().__init__()</code>.</li>
<li>Derived classes must implement the <code>GetDefaultParameters</code> classmethod.</li>
</ul>
<p>Here's how registering would work for a new class <code>Registered</code> defined in <code>python_scripts/Registered.py</code>:</p>
<div class="fragment"><div class="line"><span class="comment"># python_scripts/Registered.py</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> KratosMultiphysics.WRApplication <span class="keyword">as</span> WRApp</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Registered(WRApp.WRAppClass):</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        super().__init__()</div>
<div class="line"> </div>
<div class="line">    <span class="preprocessor">@classmethod</span></div>
<div class="line">    <span class="keyword">def </span>GetDefaultParameters(cls) -&gt; KratosMultiphysics.Parameters:</div>
<div class="line">        <span class="keywordflow">return</span> KratosMultiphysics.Parameters()</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>RegisteredSub(Registered):</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        super().__init__()</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">__all__ = [<span class="stringliteral">&quot;Registered, RegisteredSub&quot;</span>]</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment"># python_scripts/__init__.py</span></div>
<div class="line">...</div>
<div class="line"><span class="keyword">from</span> .RegisteredClass <span class="keyword">import</span> *</div>
<div class="line">...</div>
</div><!-- fragment --><p>Registered classes are accessible through interface functions defined in the registry utilities, for example: </p><div class="fragment"><div class="line">registered_dict = KratosMultiphysics.WRApplication.RegisteredClassFactory(<span class="stringliteral">&quot;WRApplication.Registered.RegisteredSub&quot;</span>, <span class="comment"># &lt;== path in the runtime registry the class is registered at</span></div>
<div class="line">                                                                          *args, <span class="comment"># &lt;== positional arguments passed to the constructor</span></div>
<div class="line">                                                                          **kwargs) <span class="comment"># &lt;== keyword arguments passed to the constructor</span></div>
</div><!-- fragment --><p><b>C++ classes</b> are also automatically registered in the python <code>Registry</code> if they are exposed via <code>pybind</code> and inherit from the C++ <code><a class="el" href="classWRAppClass.html" title="WRApp::WRAppClass with a replaced metaclass for compatibility with abc.">WRAppClass</a></code>. Note that intermediate base classes will only appear on their access path if those intermediates are also exposed to python.</p>
<p><a class="anchor" id="testing"></a></p>
<h1><a class="anchor" id="autotoc_md18"></a>
Testing</h1>
<p><a class="anchor" id="testing.cpp"></a></p>
<h2><a class="anchor" id="autotoc_md19"></a>
C++</h2>
<p>No tests are written yet in C++; exposed classes' tests are implemented in python.</p>
<p><a class="anchor" id="testing.python"></a></p>
<h2><a class="anchor" id="autotoc_md20"></a>
Python</h2>
<p>Python tests in <code>WRApplication</code> should inherit from the custom <code>TestCase</code> class that adds automatic detection and a flag system. By default, every test case is executed in all test suites, including MPI runs. Alternatively, the list of suites the test case is added to can be restricted by defining the <code>suite_flags</code> static member bitfield of the case:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> KratosMultiphysics.WRApplication <span class="keyword">as</span> WRApp</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MyTestCase(WRApp.TestCase):</div>
<div class="line">    suite_flags = WRApp.SuiteFlags.NIGHTLY | WRApp.SuiteFlags.NO_MPI</div>
<div class="line"> </div>
<div class="line">    ...</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
